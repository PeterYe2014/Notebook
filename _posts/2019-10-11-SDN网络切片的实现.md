# 基于SDN的网络切片的实现



## 切片计算

一个线性规划问题



## 切片部署

**部署的关键问题**

1. 端口队列的创建：

   input => 计算好的链路，以及上面分配好的最小带宽（<1,3,100>）

   output => 每个交换机，每个端口上创建的队列，以及每个队列对应的切片

2. 流表下发:（收到一个报文p， 该用哪个端口转发，该入哪一个队列）

   - 根据报文及系统信息，得到源交换机编号和目标交换机编号

   - 计算源交换机到目的交换机的最短路径path，path里面是反向路径，每一个元素对应一个交换机编号和端口

   - 根据报文创建匹配规则m

   - 从最后一个开始，i = i -2; 遍历每个path[i]:

     - 新建FlowMod消息
     - 修改匹配，入端口为 path[i-1].port
     - 添加 action=output:path[i].port 
     - 查看 链路层类型字段是否为 ipv4，如果是则 获取IPv4报文：
       - 获取ip报文的dscp字段，查询该类型数据在该交换机上需要入哪一个队列q
       - 添加入队动作set_queue:q
- 给消息设置actions，匹配，发送FlowMod消息（流表下发）
  
3. 流量调度算法

   - 定义：

     切片带宽利用率 = min(切片路径带宽利用率)

     切片路径带宽利用率 =  max(切片端口带宽利用率)

     切片端口带宽利用率 = 切片端口带宽 / 该端口该切片流分配最大的带宽

     > 1. 需要实时采集的数据，某个切片流，在端口的实时带宽（线程采集）
     >
     > 2. 划分切片时准备的数据，每个端口，每个切片分配的最大带宽

   - BE流量调度： 不需要刻意调度
   - QoS 切片流量调度
     - 片间调度，当前流对应切片带宽利用率小于90%，选择当前切片路由；否则：选择更高级别的切片
     - 片内调度：寻找片内的其它低带宽利用率新路由
       - 片内存在多个路径，选择最小利用率的路径来进行路由
     
     > 调度的关键在于设置阻塞的链路，或者端口，然后重新计算新的路径，如果存在就切换，如果不存在就不切换
     >
     > 1. 获取满载的端口
     > 2. 阻塞端口所在的链路
     > 3. 重新计算最短的路径，下发流表

4. 系统测试（日志形式）

   1. 切片是否正确部署
   2. 切片能否正确路由：AF、BE、EF三个切片正确路由
   3. 切片的带宽分配是否正确
   4. 片内调度是否可行
   5. 片外调度是否可行

   > 难点，怎么发送切片流量
   >
   > 1. 搞定 iperf3来测试一下就好



## Cheet Sheet

```
sudo ovs-vsctl set port s1-eth1 qos=@sliceqos -- \
--id=@sliceqos create qos type=linux-htb \
other-config:max-rate=8000000  \
queues=0=@q0 -- \
--id=@q0 create queue other-config:max-rate=1000000 -- 
```

```
tc -s -d class show dev s1-eth1
```

```
mininet> h2 python -m SimpleHTTPServer 80 >& /tmp/http.log &
mininet> h3 wget -O - h2

sudo mn --switch ovs --controller ref --topo tree,depth=2,fanout=8 --test pingall
```

