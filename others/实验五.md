## 实验五

本实验对传统的二层交换以及SDN的二层交换分别进行介绍，主要包括传统交换机的自学习算法、环路问题的解决、OpenDaylight中l2-switch的主要模块构成以及相应的功能简介，并且简单介绍了了l2-switch模块的工作流程，实验中通过抓包来深入理解传统网络和SDN网络，l2-switch建立的报文转发情况，进一步加深对SDN的理解和认识，

## 1 实验原理

### 1.1 传统的二层交换

根据OSI网络模型，网络第二层为以太网层，主要负责在同一个局域网里面通过交换机设备传输以太网帧，该层核心的思想是交换机的自学习，通过交换机的自学习，无论交换机随时安装或者卸载，都能够自主地建立二层交换规则，交换机自学习的方式主要构造目的MAC地址和对应的转发端口的映射关系，从而实现将以太网帧传送给指定的目的MAC主机的目的，下面通过一个例子来讲一下。

![](C:\Users\35114\Downloads\Topo (3).png)

上图的网络拓扑中有两台主机，两台交换机依次连接，并且两台交换机各自有一张（mac, port）映射表，该表指定二层目标地址的报文应该通过port转发，也就是说交换机自学习的目的就是为了生成一张映射表。交换机学习的核心过程为：

1）Host A发送 ARP请求报文给switch 1，switch 1，记录报文进入端口和报文源mac地址，一开始switch 1的交换机表为空，所以switch 1收到报文后就开始广播报文到其它所有端口

**Table of switch 1:**

|      Dst MAC      | Engress |
| :---------------: | ------- |
| b2:a0:ec:f1:b6:16 | eth1    |

2）switch 2接收到switch 1广播的ARP报文，也记录下报文进入端口和报文源mac地址，然后广播到其它端口

**Table of switch 2:**

|      Dst MAC      | Engress |
| :---------------: | ------- |
| b2:a0:ec:f1:b6:16 | eth2    |

3）Host B接收到ARP请求报文，然后发送ARP响应报文给Host A

4）switch 2从端口eth1接收到响应报文，记录报文进入端口和报文源mac地址，然后广播到其它端口：

**Table of switch 2:**

|      Dst MAC      | Engress |
| :---------------: | ------- |
| b2:a0:ec:f1:b6:16 | eth2    |
| 16:2a:0d:0a:fa:a5 | eth1    |

5) switch 1从端口eth2 收到响应报文，记录报文进入端口和报文mac地址，然后广播到其它端口：

**Table of switch 1:**

|      Dst MAC      | Engress |
| :---------------: | ------- |
| b2:a0:ec:f1:b6:16 | eth1    |
| 16:2a:0d:0a:fa:a5 | eth2    |

6）Host A收到ARP响应报文，两个交换机的mac-port映射表学习完成。

### 1.2 SDN中的二层交换

![](C:\Users\35114\Desktop\图片1.png)

SDN中的二层交换和传统网络中的二层交换解决的是同一个问题，也就是当交换机收到一个以太网帧后，该从哪个端口转发报文，从而使得报文在目标主机能够接收到。不过由于SDN将网络的控制平面和数据平面分离了，那么他也就不像传统网络那样直接在交换机上实现二层交换的控制逻辑。而是在控制器上实现交换机的自学习，然后下发流表规则给交换机，让交换机根据流表转发报文。不同的控制器也有不同的二层交换的实现，本实验以OpenDaylight控制器来讲解，OpenDaylight控制器中实现二层交换的**karaf**模块是```l2-switch```[^1]，该模块主要由子模块 ```PacketHandler```（数据包接收模块）、```AddressTracker```（地址学习子模块）、```HostTracker```（主机学习子模块）、```ArpHandler```(ARP 包处理模块子模块)、```LoopRemover``（环路消除子模块）组成，模块图如下图所示。

[^1]: release/oxygen-sr2 https://github.com/opendaylight/l2switch/releases



![](C:\Users\35114\Downloads\Topo (1).png)

假如Host A要通过switch 1向Host B发送ICMP报文，OpenDaylight的l2-switch模块给交换机建立流表的主要的工作流程为：

1）网络连接上控制器后，交换机与控制器之间就发送LLDP消息，通过loop-remover模块构造网络拓扑

2）根据网络拓扑，使用Prim算法生成MST(minimum spanning tree)，获取MST的链路集合

3）根据MST设置交换机端口状态，如果某条链路存在在MST链路集合中，设置链路相关的两个端口状态为*Forwaring*，可以转发报文，否则设置两个端口状态为 *Discarding*，丢弃报文

4）先给switch 1下发初始的流表，广播流表以及传输报文到控制器的流表（匹配所有的报文）

5）Host A发送ARP报文给switch 1

6）switch 1查询流表，发现通用匹配，将ARP报文交给控制器，并且通过其它端口广播

7）控制器接收到ARP报文后，存储该报文的源MAC地址，进入switch 1交换机的接口，源IP地址到DataBroker

8）控制器在DataBroker中查找switch 1上目的MAC为Mac B的出口接口outport

9）下发双向流表到交换机1，如下：

- priority=10,dl_src=b2:a0:ec:f1:b6:16,dl_dst=16:2a:0d:0a:fa:a5 actions=output:1
- priority=10,dl_src=16:2a:0d:0a:fa:a5,dl_dst=b2:a0:ec:f1:b6:16 actions=output:2

10）Host A发送ICMP报文给Host B，通过流表匹配，找到转发路径

